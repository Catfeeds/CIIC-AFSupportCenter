<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ciicsh.gto.afsupportcenter.socialsecurity.soccommandservice.dao.SsComTaskMapper">
    <resultMap id="ModelResultMap"
               type="com.ciicsh.gto.afsupportcenter.socialsecurity.soccommandservice.dto.SsComTaskDTO"
               extends="BaseResultMap">
        <result column="title" property="companyName"/>
    </resultMap>
    <resultMap id="getMaterialResultMap"
               type="com.ciicsh.gto.afsupportcenter.socialsecurity.soccommandservice.dto.SsComTaskDTO"
               extends="ModelResultMap">
        <association property="ssComAccountDTO"
                     javaType="com.ciicsh.gto.afsupportcenter.socialsecurity.soccommandservice.dto.SsComAccountDTO">
            <result column="com_account_id_acc" property="comAccountId"/>
            <result column="supplier_id" property="supplierId"/>
            <result column="ss_account_type" property="ssAccountType"/>
            <result column="ss_account" property="ssAccount"/>
            <result column="bank_account" property="bankAccount"/>
            <result column="com_account_name" property="comAccountName"/>
            <result column="settlement_area" property="settlementArea"/>
            <result column="payment_bank" property="paymentBank"/>
            <result column="payment_way" property="paymentWay"/>
            <result column="expire_date_acc" property="expireDate"/>
            <result column="ss_username" property="ssUsername"/>
            <result column="ss_pwd" property="ssPwd"/>
            <result column="initial_balance" property="initialBalance"/>
            <result column="initial_debt" property="initialDebt"/>
            <result column="origin_place" property="originPlace"/>
            <result column="origin_place_remark" property="originPlaceRemark"/>
            <result column="query_account" property="queryAccount"/>
            <result column="deliver_way" property="deliverWay"/>
            <result column="deliver_way_remark" property="deliverWayRemark"/>
            <result column="provide_certificate_time" property="provideCertificateTime"/>
            <result column="state" property="state"/>
            <result column="change_time" property="changeTime"/>
            <result column="receive_date" property="receiveDate"/>
            <result column="into_date" property="intoDate"/>
            <result column="end_date" property="endDate"/>
            <result column="dispatch_material" property="dispatchMaterial"/>
            <result column="remark_acc" property="remark"/>
            <association property="ssAccountRatio"
                         javaType="com.ciicsh.gto.afsupportcenter.socialsecurity.soccommandservice.entity.SsAccountRatio">
                <id column="ss_account_ratio_id" property="ssAccountRatioId"/>
                <result column="com_account_id_sar" property="comAccountId"/>
                <result column="industry_category" property="industryCategory"/>
                <result column="com_ratio" property="comRatio"/>
                <result column="start_month" property="startMonth"/>
                <result column="end_month" property="endMonth"/>
                <result column="is_active" property="isActive"/>
            </association>
        </association>
        <collection property="materialList"
                    ofType="com.ciicsh.gto.afsupportcenter.socialsecurity.soccommandservice.entity.SsComMaterial">
            <id column="com_material_id" property="comMaterialId"/>
            <result column="company_task_id_m" property="companyTaskId"/>
            <result column="material_type" property="materialType"/>
            <result column="material_name" property="materialName"/>
            <result column="submit_time_m" property="submitTime"/>
            <result column="receive_time" property="receiveTime"/>
            <result column="remark" property="remark"/>
            <result column="status" property="status"/>
            <result column="is_active" property="isActive"/>
            <result column="created_time" property="createdTime"/>
            <result column="modified_time" property="modifiedTime"/>
            <result column="created_by" property="createdBy"/>
            <result column="modified_by" property="modifiedBy"/>
        </collection>
    </resultMap>

    <resultMap id="getComAccountResultMap"
               type="com.ciicsh.gto.afsupportcenter.socialsecurity.soccommandservice.dto.SsComTaskDTO"
               extends="ModelResultMap">
        <association property="ssComAccountDTO"
                     javaType="com.ciicsh.gto.afsupportcenter.socialsecurity.soccommandservice.dto.SsComAccountDTO">
            <result column="com_account_id_acc" property="comAccountId"/>
            <result column="supplier_id" property="supplierId"/>
            <result column="ss_account_type" property="ssAccountType"/>
            <result column="ss_account" property="ssAccount"/>
            <result column="bank_account" property="bankAccount"/>
            <result column="com_account_name" property="comAccountName"/>
            <result column="settlement_area" property="settlementArea"/>
            <result column="payment_bank" property="paymentBank"/>
            <result column="payment_way" property="paymentWay"/>
            <result column="expire_date_acc" property="expireDate"/>
            <result column="ss_username" property="ssUsername"/>
            <result column="ss_pwd" property="ssPwd"/>
            <result column="initial_balance" property="initialBalance"/>
            <result column="initial_debt" property="initialDebt"/>
            <result column="origin_place" property="originPlace"/>
            <result column="origin_place_remark" property="originPlaceRemark"/>
            <result column="query_account" property="queryAccount"/>
            <result column="deliver_way" property="deliverWay"/>
            <result column="deliver_way_remark" property="deliverWayRemark"/>
            <result column="provide_certificate_time" property="provideCertificateTime"/>
            <result column="change_time" property="changeTime"/>
            <result column="receive_date" property="receiveDate"/>
            <result column="into_date" property="intoDate"/>
            <result column="end_date" property="endDate"/>
            <result column="dispatch_material" property="dispatchMaterial"/>
            <result column="remark_acc" property="remark"/>
            <association property="ssAccountRatio"
                         javaType="com.ciicsh.gto.afsupportcenter.socialsecurity.soccommandservice.entity.SsAccountRatio">
                <id column="ss_account_ratio_id" property="ssAccountRatioId"/>
                <result column="com_account_id_sar" property="comAccountId"/>
                <result column="industry_category" property="industryCategory"/>
                <result column="com_ratio" property="comRatio"/>
                <result column="start_month" property="startMonth"/>
                <result column="end_month" property="endMonth"/>
                <result column="is_active" property="isActive"/>
            </association>
        </association>
    </resultMap>
    <!--查询企业任务单 未处理状态-->
    <select id="queryNoProgressCompanyTask" resultMap="ModelResultMap">
        SELECT
        sct.company_id,
        sct.company_task_id,
        sct.task_category,
        sct.customer_id,
        sct.expire_date,
        sct.submitter_id,
        sct.submit_time,
        sct.submit_remark,
        cc.title
        FROM ss_com_task sct
        LEFT JOIN sal_company cc ON sct.company_id = cc.company_id
        <where>
            AND sct.is_active = 1
            AND sct.task_status = 0
            <if test="companyName!= null">
                AND cc.title LIKE CONCAT('%', #{companyName}, '%')
            </if>
            <if test="taskCategory!= null">
                AND sct.task_category = #{taskCategory}
            </if>
            <if test="companyId!= null">
                AND sct.company_id = #{companyId}
            </if>
            <if test="submitTimeStart!= null">
                AND sct.submit_time <![CDATA[ >= ]]> #{submitTimeStart}
            </if>
            <if test="submitTimeEnd!= null ">
                AND sct.submit_time <![CDATA[ <= ]]> #{submitTimeEnd}
            </if>
        </where>
    </select>

    <!--查询企业任务单 处理中状态-->
    <select id="queryProgressingCompanyTask" resultMap="ModelResultMap">
        SELECT * FROM(
        SELECT
        sct.task_status,
        sct.company_id,
        sct.company_task_id,
        sct.task_category,
        sct.customer_id,
        sct.expire_date,
        sct.submitter_id,
        sct.submit_time,
        sct.submit_remark,
        cc.title
        FROM ss_com_task sct
        LEFT JOIN ss_com_account sca ON sct.com_account_id = sca.com_account_id
        LEFT JOIN sal_company cc ON sct.company_id = cc.company_id
        <where>
            AND sct.is_active = 1
            <if test="accountType!= null ">
                AND sca.ss_account_type = #{accountType}
            </if>
            <if test="regionValue!= null ">
                AND sca.settlement_area LIKE CONCAT('%',#{regionValue}, '%')
            </if>
            <if test="taskStatus!= null ">
                AND sct.task_status = #{taskStatus}
            </if>

            <if test="companyName!= null">
                AND cc.title LIKE CONCAT('%', #{companyName}, '%')
            </if>
            <if test="taskCategory!= null">
                AND sct.task_category = #{taskCategory}
            </if>
            <if test="companyId!= null">
                AND sct.company_id = #{companyId}
            </if>
            <if test="submitTimeStart!= null">
                AND sct.submit_time <![CDATA[ >= ]]> #{submitTimeStart}
            </if>
            <if test="submitTimeEnd!= null ">
                AND sct.submit_time <![CDATA[ <= ]]> #{submitTimeEnd}
            </if>
        </where>
        )x
        <where>
            <if test="taskStatus== null ">
                AND x.task_status = 1 OR x.task_status = 2
            </if>
        </where>
    </select>
    <!--查询企业任务单 已完成状态-->
    <select id="queryFinshedCompanyTask" resultMap="ModelResultMap">
        SELECT
        sct.company_id,
        sct.company_task_id,
        sct.task_category,
        sct.customer_id,
        sct.expire_date,
        sct.submitter_id,
        sct.submit_time,
        sct.submit_remark,
        cc.title
        FROM ss_com_task sct
        LEFT JOIN ss_com_account sca ON sct.com_account_id = sca.com_account_id
        LEFT JOIN sal_company cc ON sct.company_id = cc.company_id
        <where>
            AND sct.is_active = 1
            AND sct.task_status =3
            <if test="accountType!= null ">
                AND sca.ss_account_type = #{accountType}
            </if>
            <if test="regionValue!= null ">
                AND sca.settlement_area LIKE CONCAT('%',#{regionValue}, '%')
            </if>
            <if test="companyName!= null">
                AND cc.title LIKE CONCAT('%', #{companyName}, '%')
            </if>
            <if test="taskCategory!= null">
                AND sct.task_category = #{taskCategory}
            </if>
            <if test="companyId!= null">
                AND sct.company_id = #{companyId}
            </if>
            <if test="submitTimeStart!= null">
                AND sct.submit_time <![CDATA[ >= ]]> #{submitTimeStart}
            </if>
            <if test="submitTimeEnd!= null ">
                AND sct.submit_time <![CDATA[ <= ]]> #{submitTimeEnd}
            </if>
        </where>
    </select>

    <!--查询企业任务单 批退状态-->
    <select id="queryRefusedCompanyTask" resultMap="ModelResultMap">
        SELECT
        sct.company_id,
        sct.company_task_id,
        sct.task_category,
        sct.customer_id,
        sct.expire_date,
        sct.submitter_id,
        sct.submit_time,
        sct.submit_remark,
        cc.title
        FROM ss_com_task sct
        LEFT JOIN sal_company cc ON sct.company_id = cc.company_id
        <where>
            AND sct.is_active = 1
            AND sct.task_status = 4
            <if test="companyName!= null">
                AND cc.title LIKE CONCAT('%', #{companyName}, '%')
            </if>
            <if test="taskCategory!= null">
                AND sct.task_category = #{taskCategory}
            </if>
            <if test="companyId!= null">
                AND sct.company_id = #{companyId}
            </if>
            <if test="submitTimeStart!= null">
                AND sct.submit_time <![CDATA[ >= ]]> #{submitTimeStart}
            </if>
            <if test="submitTimeEnd!= null ">
                AND sct.submit_time <![CDATA[ <= ]]> #{submitTimeEnd}
            </if>
        </where>
    </select>

    <!-- 批量修改 修改任务单状态-->
    <update id="updatePatchRefuseTask" parameterType="java.util.List">

        UPDATE ss_com_task sct SET sct.task_status = 4

        WHERE company_task_id IN
        <foreach collection="list" item="item" index="index" open="(" separator="," close=")">
            #{item.companyTaskId}
        </foreach>
    </update>

    <!-- 查询企业信息和材料 -->
    <select id="queryComInfoAndMaterial" resultMap="getMaterialResultMap">
        SELECT
        sct.company_id,
        sct.company_task_id,
        sct.task_category,
        sct.customer_id,
        sct.expire_date,
        sct.submitter_id,
        sct.submit_time,
        sct.submit_remark,
        sct.task_status,
        cc.title,
        scm.*
        FROM ss_com_task sct
        LEFT JOIN (SELECT company_id, title FROM sal_company WHERE is_active = 1)cc ON sct.company_id = cc.company_id
        LEFT JOIN
        (SELECT
        com_material_id,
        company_task_id AS company_task_id_m,
        material_type,
        material_name,
        submit_time AS submit_time_m,
        receive_time,
        remark,
        `status`
        FROM
        ss_com_material WHERE is_active = 1
        )
        scm ON sct.company_task_id = scm.company_task_id_m
        WHERE
        sct.is_active =1
        AND sct.company_task_id = #{companyTaskId}
        <if test="isComplete ==0 ">
            AND sct.task_status != 3
        </if>
        <if test="isComplete ==3">
            AND sct.task_status = 3
        </if>
        <if test="isComplete ==4">
            AND sct.task_status = 4
        </if>
    </select>
    <!--查询账户信息和材料-->
    <select id="queryAccountInfoAndMaterial" resultMap="getMaterialResultMap">
        SELECT
        sct.company_id,
        sct.company_task_id,
        sct.task_category,
        sct.customer_id,
        sct.expire_date,
        sct.submitter_id,
        sct.submitter_name,
        sct.submit_time,
        sct.submit_remark,
        sct.task_status,
        sct.task_form_content,
        sct.start_handle_date,
        sct.send_check_date,
        sct.finish_date,
        sct.handle_remark,
        sct.dynamic_extend,
        sc.title,
        scm.*,
        sca.*
        FROM ss_com_task sct
        LEFT JOIN (SELECT com_account_id AS com_account_id_acc,
        supplier_id,ss_account_type,ss_account,bank_account,com_account_name,settlement_area,payment_bank,payment_way,expire_date
        AS
        expire_date_acc,ss_username,ss_pwd,initial_balance,initial_debt,origin_place,origin_place_remark,query_account,deliver_way,deliver_way_remark,provide_certificate_time,change_time,receive_date,into_date,end_date,dispatch_material,remark
        AS remark_acc,state FROM ss_com_account)sca ON sct.com_account_id = sca.com_account_id_acc
        LEFT JOIN
        (SELECT
        com_material_id,
        company_task_id AS company_task_id_m,
        material_type,
        material_name,
        submit_time AS submit_time_m,
        receive_time,
        remark,
        `status`
        FROM
        ss_com_material WHERE is_active = 1
        )
        scm ON sct.company_task_id = scm.company_task_id_m
        LEFT JOIN (SELECT company_id, title FROM sal_company WHERE is_active = 1)sc ON sct.company_id = sc.company_id
        WHERE
        sct.is_active =1
        AND sct.company_task_id = #{companyTaskId}
        <if test="isComplete ==0 ">
            AND sct.task_status != 3
        </if>
        <if test="isComplete ==3">
            AND sct.task_status = 3
        </if>
        <if test="isComplete ==4">
            AND sct.task_status = 4
        </if>
    </select>

    <!-- 查询企业信息和前道传来的JSON 解析到期时间和支付方式 -->
    <select id="queryComInfoAndPayWay" resultMap="getComAccountResultMap">
        SELECT
        sct.company_id,
        sct.com_account_id,
        sct.company_task_id,
        sct.task_category,
        sct.customer_id,
        sct.expire_date,
        sct.submitter_id,
        sct.submit_time,
        sct.submit_remark,
        sct.task_status,
        sct.task_form_content,
        sct.start_handle_date,
        sct.send_check_date,
        sct.finish_date,
        sct.handle_remark,
        sc.title,
        sca.*,
        sat.*
        FROM ss_com_task sct
        LEFT JOIN (SELECT company_id, title FROM sal_company WHERE is_active = 1)sc ON sct.company_id = sc.company_id
        LEFT JOIN (SELECT com_account_id AS com_account_id_acc,
        supplier_id,ss_account_type,ss_account,bank_account,com_account_name,settlement_area,payment_bank,payment_way,expire_date
        AS
        expire_date_acc,ss_username,ss_pwd,initial_balance,initial_debt,origin_place,origin_place_remark,query_account,deliver_way,deliver_way_remark,provide_certificate_time,change_time,receive_date,into_date,end_date,dispatch_material,remark
        AS remark_acc FROM ss_com_account WHERE is_active = 1)sca
        ON sct.com_account_id = sca.com_account_id_acc
        LEFT JOIN (SELECT ss_account_ratio_id, com_account_id AS
        com_account_id_sar,industry_category,com_ratio,start_month,end_month FROM ss_account_ratio WHERE is_active =1
        )sat
        ON sca.com_account_id_acc = sat.com_account_id_sar
        WHERE
        sct.is_active =1
        AND sct.company_task_id = #{companyTaskId}
        <if test="isComplete ==0 ">
            AND sct.task_status != 3
        </if>
        <if test="isComplete ==3">
            AND sct.task_status = 3
        </if>
        <if test="isComplete ==4">
            AND sct.task_status = 4
        </if>
    </select>

    <update id="updateTaskStatusForRevoke" parameterType="com.ciicsh.gto.afsupportcenter.socialsecurity.soccommandservice.entity.SsComTask">
        UPDATE ss_com_task sct
        SET
        <if test="taskStatus == 1">
            sct.start_handle_date=NULL,
        </if>
        <if test="taskStatus == 2">
            sct.send_check_date=NULL,
         </if>
        <if test="taskStatus != null">
            <if test="modifiedBy != null">
                sct.modified_by =#{modifiedBy},
            </if>
            <if test="modifiedTime != null">
                sct.modified_time=#{modifiedTime},
            </if>
            sct.task_status = #{taskStatus}-1
        </if>
        WHERE
            sct.company_task_id = #{companyTaskId}
    </update>
</mapper>
