<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ciicsh.gto.afsupportcenter.housefund.siteservice.dao.HfEmpTaskMapper">

	<!-- 通用查询映射结果 -->
	<resultMap id="BaseResultBo" type="com.ciicsh.gto.afsupportcenter.housefund.siteservice.bo.HfEmpTaskBo">
		<result column="emp_task_id" property="empTaskId" />
		<result column="company_id" property="companyId" />
        <result column="company_name" property="companyName" />
		<result column="employee_id" property="employeeId" />
        <result column="employee_name" property="employeeName" />
        <result column="id_num" property="idNum" />
		<result column="hf_type" property="hfType" />
        <result column="hf_emp_account" property="hfEmpAccount" />
		<result column="task_category" property="taskCategory" />
		<result column="urgent" property="urgent" />
		<result column="submitter_id" property="submitterId" />
        <result column="submit_time" property="submitTime" />
		<result column="task_id" property="taskId" />
	</resultMap>

    <resultMap id="BaseResultHandleBo" type="com.ciicsh.gto.afsupportcenter.housefund.siteservice.bo.HfEmpTaskHandleBo">
        <result column="emp_task_id" property="empTaskId" />
        <result column="emp_archive_id" property="empArchiveId" />
        <result column="hf_type" property="hfType" />
        <result column="task_category" property="taskCategory" />
        <result column="task_status" property="taskStatus" />
        <result column="company_id" property="companyId" />
        <result column="company_name" property="companyName" />
        <result column="employee_id" property="employeeId" />
        <result column="employee_name" property="employeeName" />
        <result column="id_num" property="idNum" />
        <result column="payment_bank" property="paymentBank" />
        <result column="state" property="state" />
        <result column="payment_way" property="paymentWay" />
        <result column="ukey_store" property="ukeyStore" />
        <result column="com_account_name" property="comAccountName" />
        <result column="basic_com_task_status" property="basicComTaskStatus" />
        <result column="added_com_task_status" property="addedComTaskStatus" />
        <result column="hf_account_type" property="hfAccountType" />
        <result column="basic_hf_com_account" property="basicHfComAccount" />
        <result column="basic_com_hf_month" property="basicComHfMonth" />
        <result column="basic_end_month" property="basicEndMonth" />
        <result column="added_hf_com_account" property="addedHfComAccount" />
        <result column="added_com_hf_month" property="addedComHfMonth" />
        <result column="added_end_month" property="addedEndMonth" />
        <result column="in_date" property="inDate" />
        <result column="hf_emp_account" property="hfEmpAccount" />
        <result column="start_month" property="startMonth" />
        <result column="end_month" property="endMonth" />
        <result column="amount" property="amount" />
        <result column="emp_base" property="empBase" />
        <result column="ratio_com" property="ratioCom" />
        <result column="ratio_emp" property="ratioEmp" />
        <result column="basic_hf_emp_account" property="basicHfEmpAccount" />
        <result column="basic_emp_archive_id" property="basicEmpArchiveId" />
        <result column="basic_archive_status" property="basicArchiveStatus" />
        <result column="added_hf_emp_account" property="addedHfEmpAccount" />
        <result column="added_emp_archive_id" property="addedEmpArchiveId" />
        <result column="added_archive_status" property="addedArchiveStatus" />
        <result column="operation_remind" property="operationRemind" />
        <result column="operation_remind_date" property="operationRemindDate" />
    </resultMap>

    <select id="queryHfEmpTask" resultMap="BaseResultBo">
        SELECT
        het.emp_task_id,
        het.task_category,
        het.urgent,
        het.employee_id,
        ee.employee_name,
        ee.id_num,
        het.company_id,
        sc.title company_name,
        hea.hf_type,
        hea.hf_emp_account,
        het.submitter_id,
        het.submit_time,
        het.task_id
        FROM hf_emp_task het
        INNER JOIN hf_account_com_relation hacr ON het.company_id = hacr.company_id AND hacr.is_active = 1
        INNER JOIN hf_com_account hca ON hacr.com_account_id = hca.com_account_id AND hca.is_active = 1
        INNER JOIN emp_employee ee ON het.employee_id = ee.employee_id
        INNER JOIN sal_company sc ON het.company_id = sc.company_id AND sc.is_active = 1
        LEFT JOIN hf_emp_archive hea ON het.emp_archive_id = hea.emp_archive_id AND hea.is_active = 1
        <where>
            het.is_active = 1 AND IFNULL(het.task_status, 1) != 5
            AND het.task_category != 9
            <if test="taskCategory != null">
                AND het.task_category = #{taskCategory}
            </if>
            <if test="employeeId != null">
                AND ee.employee_id = #{employeeId}
            </if>
            <if test="employeeName != null">
                AND ee.employee_name LIKE CONCAT('%',#{employeeName},'%')
            </if>
            <if test="idNum != null">
                AND ee.id_num = #{idNum}
            </if>
            <if test="companyId != null">
                AND sc.company_id = #{companyId}
            </if>
            <if test="hfAccountType != null">
                AND hca.hf_account_type = #{hfAccountType}
            </if>
            <if test="hfType != null">
                AND hca.hf_type = #{hfType}
            </if>
            <if test="paymentBank != null">
                AND hca.payment_bank = #{paymentBank}
            </if>
            <if test="urgent == 1">
                AND het.urgent = #{urgent}
            </if>
            <if test="submitTimeStart != null">
                AND het.submit_time >= #{submitTimeStart}
            </if>
            <if test="submitTimeEnd != null">
                AND #{submitTimeEnd} >= het.submit_time
            </if>
            <if test="taskStatus == null">
                AND IFNULL(het.task_status, 1) = 1
            </if>
            <if test="processStatus == 1">
                AND het.submit_time <![CDATA[ <= ]]>
                str_to_date(CONCAT(date_format(CURTIME(),'%Y-%m'),'-',hca.close_day),'%Y-%m-%d')
            </if>
            <if test="processStatus == 2">
                AND et.submit_time >
                str_to_date(CONCAT(date_format(CURTIME(),'%Y-%m'),'-',hca.close_day),'%Y-%m-%d')
            </if>
        </where>
    </select>

    <select id="getEmpTaskHandleData" resultMap="BaseResultHandleBo">
        SELECT DISTINCT
        het.emp_task_id,
        het.emp_archive_id,
        het.hf_type,
        het.task_category,
        het.task_status,
        sc.company_id,
        sc.title AS company_name,
        hca.payment_bank,
        hca.state,
        hca.payment_way,
        hca.ukey_store,
        IFNULL(hca.com_account_name, hctb.com_account_name) AS com_account_name,
        CASE WHEN hcacb.com_account_class_id IS NOT NULL THEN 3 ELSE hctb.task_status END AS basic_com_task_status,
        CASE WHEN hcaca.com_account_class_id IS NOT NULL THEN 3 ELSE hcta.task_status END AS added_com_task_status,
        IFNULL(hca.hf_account_type, 3) AS hf_account_type,
        IFNULL(hcacb.hf_com_account, hctb.hf_com_account) AS basic_hf_com_account,
        IFNULL(hcacb.com_hf_month, CONVERT(hctb.com_start_month, SIGNED)) AS basic_com_hf_month,
        IFNULL(hcacb.end_month, hctb.end_month) AS basic_end_month,
        IFNULL(hcaca.hf_com_account, hcta.hf_com_account) AS added_hf_com_account,
        IFNULL(hcaca.com_hf_month, CONVERT(hcta.com_start_month, SIGNED)) AS added_com_hf_month,
        IFNULL(hcaca.end_month, hcta.end_month) AS added_end_month,
        ee.employee_id,
        ee.employee_name,
        ee.id_num,
        het.in_date,
        het.hf_emp_account,
        het.task_status,
        het.start_month,
        het.end_month,
        het.amount,
        het.emp_base,
        het.ratio_com,
        het.ratio_emp,
        het.emp_archive_id,
        heab.hf_emp_account AS basic_hf_emp_account,
        heab.emp_archive_id AS basic_emp_archive_id,
        heab.archive_status AS basic_archive_status,
        heaa.hf_emp_account AS added_hf_emp_account,
        heaa.emp_archive_id AS added_emp_archive_id,
        heaa.archive_status AS added_archive_status,
        het.operation_remind,
        het.operation_remind_date
        FROM hf_emp_task het
        INNER JOIN sal_company sc ON het.company_id = sc.company_id AND sc.is_active = 1
        INNER JOIN emp_employee ee ON het.employee_id = ee.employee_id
        LEFT JOIN hf_account_com_relation hacr ON het.company_id = hacr.company_id AND hacr.is_active = 1
        LEFT JOIN hf_com_account hca ON hacr.com_account_id = hca.com_account_id AND hca.is_active = 1
        LEFT JOIN hf_com_account_class hcacb ON hca.com_account_id = hcacb.com_account_id AND hcacb.is_active = 1 AND hcacb.hf_type = 1
        LEFT JOIN hf_com_account_class hcaca ON hca.com_account_id = hcaca.com_account_id AND hcaca.is_active = 1 AND hcaca.hf_type = 2
        LEFT JOIN hf_com_task hctb ON het.company_id = hctb.company_id AND hctb.is_active = 1 AND hctb.hf_type = 1 AND hctb.task_status <![CDATA[<]]> 3
        LEFT JOIN hf_com_task hcta ON het.company_id = hcta.company_id AND hcta.is_active = 1 AND hcta.hf_type = 2 AND hcta.task_status <![CDATA[<]]> 3
        LEFT JOIN hf_emp_archive heab ON het.employee_id = heab.employee_id AND het.company_id = heab.company_id AND heab.is_active = 1 AND heab.hf_type = 1
        LEFT JOIN hf_emp_archive heaa ON het.employee_id = heaa.employee_id AND het.company_id = heaa.company_id AND heaa.is_active = 1 AND heaa.hf_type = 2
        <where>
            het.is_active = 1
            AND het.emp_task_id = #{empTaskId}
        </where>
    </select>
</mapper>
