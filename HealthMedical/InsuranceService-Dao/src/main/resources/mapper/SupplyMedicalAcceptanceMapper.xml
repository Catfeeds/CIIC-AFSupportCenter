<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ciicsh.gto.afsupportcenter.healthmedical.dao.SupplyMedicalAcceptanceMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.ciicsh.gto.afsupportcenter.healthmedical.entity.po.SupplyMedicalAcceptance">
        <id column="acceptance_id" property="acceptanceId"/>
        <result column="dossier_number" property="dossierNumber"/>
        <result column="input_date" property="inputDate"/>
        <result column="status" property="status"/>
        <result column="employee_id" property="employeeId"/>
        <result column="employee_name" property="employeeName"/>
        <result column="company_id" property="companyId"/>
        <result column="company_name" property="companyName"/>
        <result column="invoice_number" property="invoiceNumber"/>
        <result column="total_company_amount" property="totalCompanyAmount"/>
        <result column="total_insurance_company_money" property="totalInsuranceCompanyMoney"/>
        <result column="total_cs_payment_amount" property="totalCsPaymentAmount"/>
        <result column="total_application_amount" property="totalApplicationAmount"/>
        <result column="total_approved_amount" property="totalApprovedAmount"/>
        <result column="total_claim_amount" property="totalClaimAmount"/>
        <result column="type" property="type"/>
        <result column="insured_name" property="insuredName"/>
        <result column="auditor" property="auditor"/>
        <result column="audit_time" property="auditTime"/>
        <result column="created_time" property="createdTime"/>
        <result column="modified_time" property="modifiedTime"/>
        <result column="created_by" property="createdBy"/>
        <result column="modified_by" property="modifiedBy"/>
    </resultMap>

    <!-- 关联查询映射结果 -->
    <resultMap id="PaymentResultMap" type="com.ciicsh.gto.afsupportcenter.healthmedical.entity.bo.EmployeePaymentBO">
        <result column="acceptance_id" property="paymentApplyId" />
        <result column="business_id" property="businessId" />
        <result column="company_id" property="companyId" />
        <result column="company_name" property="companyName" />
        <result column="employee_id" property="employeeId" />
        <result column="employee_name" property="employeeName" />
        <result column="pay_amount" property="payAmount" />
        <result column="bank_account" property="bankAccount" />
        <result column="account_name" property="accountName" />
        <result column="bank_id" property="bankId" />
        <result column="bank_code" property="bankCode" />
        <result column="bank_name" property="bankName" />
        <result column="province_code" property="provinceCode" />
        <result column="city_code" property="cityCode" />
    </resultMap>

    <!-- 银行信息不全映射结果 -->
    <resultMap id="PartialResultMap" type="com.ciicsh.gto.afsupportcenter.healthmedical.entity.bo.EmpBankRefundBO">
        <result column="acceptance_id" property="applyId" />
        <result column="business_id" property="businessId" />
        <result column="company_id" property="companyId" />
        <result column="employee_id" property="employeeId" />
        <result column="customer_Manager" property="customerManager" />
        <result column="service_center" property="serviceCenter" />
        <result column="bankcard_id" property="bankcardId" />
        <result column="pay_amount" property="payAmount" />
        <result column="remark" property="remark" />
    </resultMap>

    <!-- 关联查询结果列 -->
    <sql id="Payment_Column_List">
        p.acceptance_id, 0 AS business_id, p.company_id, p.company_name, p.employee_id, p.employee_name, p.total_insurance_company_money AS pay_amount, b.card_num AS bank_account, b.account_name, b.bankcard_type AS bank_id, b.bank_code, b.deposit_bank AS bank_name, b.province_code, b.city_code
    </sql>

    <!-- 关联查询结果列 -->
    <sql id="Partial_Column_List">
        p.acceptance_id, 0 AS business_id, p.company_id, p.employee_id, p.total_insurance_company_money AS pay_amount, p.created_by AS customer_manager, "健康医疗部" AS service_center, "无银行卡" AS remark
    </sql>

    <select id="queryAcceptancePage"
            parameterType="com.ciicsh.gto.afsupportcenter.healthmedical.entity.dto.SupplyMedicalAcceptanceDTO"
            resultMap="BaseResultMap">
        SELECT hm_supply_medical_acceptance.*
        FROM hm_supply_medical_acceptance
        JOIN sal_company
        ON sal_company.company_id = hm_supply_medical_acceptance.company_id
        JOIN sal_management
        ON sal_management.management_id = sal_company.management_id
        <where>
            <if test="inputDateRange != null and inputDateRange.size == 2">
                AND input_date BETWEEN #{inputDateRange[0],jdbcType=TIMESTAMP} AND
                #{inputDateRange[1],jdbcType=TIMESTAMP}
            </if>
            <if test="auditTime != null">
                AND audit_time = #{auditTime,jdbcType=TIMESTAMP}
            </if>
            <if test="status != null">
                hm_supply_medical_acceptance.status = #{status,jdbcType=INTEGER}
            </if>
            <if test="dossierNumber != null and dossierNumber != '' ">
                AND dossier_number = #{dossierNumber,jdbcType=VARCHAR}
            </if>
            <if test="acceptanceId != null and acceptanceId != '' ">
                AND acceptance_id = #{acceptanceId,jdbcType=VARCHAR}
            </if>
            <if test="employeeId != null and employeeId != '' ">
                AND hm_supply_medical_acceptance.employee_id = #{employeeId,jdbcType=VARCHAR}
            </if>
            <if test="employeeName != null and employeeName != '' ">
                AND employee_name = #{employeeName,jdbcType=VARCHAR}
            </if>
            <if test="companyId != null and companyId != '' ">
                AND hm_supply_medical_acceptance.company_id = #{companyId,jdbcType=VARCHAR}
            </if>
            <if test="companyName != null and companyName != '' ">
                AND company_name = #{companyName,jdbcType=VARCHAR}
            </if>
            <if test="managementId != null and managementId != '' ">
                AND sal_company.management_id = #{managementId,jdbcType=VARCHAR}
            </if>
            <if test="managementName != null and managementName != '' ">
                AND sal_management.title = #{managementName,jdbcType=VARCHAR}
            </if>
            <if test="insuredName != null and insuredName != '' ">
                AND insured_name = #{insuredName,jdbcType=VARCHAR}
            </if>
        </where>
    </select>

    <select id="queryAcceptanceTotal"
            parameterType="com.ciicsh.gto.afsupportcenter.healthmedical.entity.dto.SupplyMedicalAcceptanceDTO"
            resultType="com.ciicsh.gto.afsupportcenter.healthmedical.entity.bo.AcceptanceStatisticsBO">
        SELECT
        count(1) total,
        sum(hm_supply_medical_acceptance.total_company_amount) totalCompanyMoney,
        sum(hm_supply_medical_acceptance.total_insurance_company_money) totalInsuranceCompanyMoney
        FROM hm_supply_medical_acceptance
        JOIN sal_company
        ON sal_company.company_id = hm_supply_medical_acceptance.company_id
        JOIN sal_management
        ON sal_management.management_id = sal_company.management_id
        <where>
            <if test="inputDateRange != null and inputDateRange.size == 2">
                AND input_date BETWEEN #{inputDateRange[0],jdbcType=TIMESTAMP} AND
                #{inputDateRange[1],jdbcType=TIMESTAMP}
            </if>
            <if test="auditTime != null">
                AND audit_time = #{auditTime,jdbcType=TIMESTAMP}
            </if>
            <if test="status != null">
                hm_supply_medical_acceptance.status = #{status,jdbcType=INTEGER}
            </if>
            <if test="dossierNumber != null and dossierNumber != '' ">
                AND dossier_number = #{dossierNumber,jdbcType=VARCHAR}
            </if>
            <if test="acceptanceId != null and acceptanceId != '' ">
                AND acceptance_id = #{acceptanceId,jdbcType=VARCHAR}
            </if>
            <if test="employeeId != null and employeeId != '' ">
                AND hm_supply_medical_acceptance.employee_id = #{employeeId,jdbcType=VARCHAR}
            </if>
            <if test="employeeName != null and employeeName != '' ">
                AND employee_name = #{employeeName,jdbcType=VARCHAR}
            </if>
            <if test="companyId != null and companyId != '' ">
                AND hm_supply_medical_acceptance.company_id = #{companyId,jdbcType=VARCHAR}
            </if>
            <if test="companyName != null and companyName != '' ">
                AND company_name = #{companyName,jdbcType=VARCHAR}
            </if>
            <if test="managementId != null and managementId != '' ">
                AND sal_company.management_id = #{managementId,jdbcType=VARCHAR}
            </if>
            <if test="managementName != null and managementName != '' ">
                AND sal_management.title = #{managementName,jdbcType=VARCHAR}
            </if>
            <if test="insuredName != null and insuredName != '' ">
                AND insured_name = #{insuredName,jdbcType=VARCHAR}
            </if>
        </where>
    </select>

    <update id="updateStatus">
        UPDATE
            gtobusinessdb.hm_supply_medical_acceptance m
        SET
            m.status = #{status, jdbcType=INTEGER},
            m.modified_by = #{modifiedBy, jdbcType=VARCHAR},
            m.modified_time= now()
        WHERE
            m.acceptance_id = #{acceptanceId, jdbcType=VARCHAR}
    </update>

    <update id="syncStatus">
        UPDATE
            gtobusinessdb.hm_supply_medical_acceptance p
        SET
            p.status = #{status},
        <if test="remark != null and remark != ''">
            p.remark = #{remark},
        </if>
            p.modified_by = #{modifiedBy, jdbcType=VARCHAR},
            p.modified_time = now()
        WHERE EXISTS
        (
            SELECT
              d.acceptance_id
            FROM
              hm_payment_apply_detail d
            WHERE
              d.acceptance_id = p.acceptance_id
            AND
              d.apply_batch_id = #{batchId, jdbcType=INTEGER}
            AND
              d.business_id = #{businessId, jdbcType=INTEGER}
        )
    </update>

    <!-- 3：审核未同步 -->
    <select id="selectAudited" resultMap="PaymentResultMap">
        SELECT
            <include refid="Payment_Column_List"/>
        FROM
            gtobusinessdb.hm_supply_medical_acceptance p, emp_company_bankcard_relation cbr, emp_bankcard b
        WHERE
            b.bankcard_id = cbr.bankcard_id
        AND
            cbr.company_id = p.company_id
        AND
            b.employee_id = p.employee_id
        AND
            p.status = 2
        AND
            cbr.usage = 2
        AND
            b.status = 1
        AND
            p.is_active = 1
        AND
            cbr.is_active = 1
    </select>

    <!-- 6：银行退票 -->
    <select id="selectRefund" resultMap="PaymentResultMap">
        SELECT
            <include refid="Payment_Column_List"></include>
        FROM
            gtobusinessdb.hm_supply_medical_acceptance p,
            gtobusinessdb.emp_bank_refund r,
            gtobusinessdb.emp_company_bankcard_relation cbr,
            gtobusinessdb.emp_bankcard b
        WHERE
            p.status = 6
        AND
            p.acceptance_id = r.apply_id
        AND
            r.business_id = 2
        AND
            r.modified_time <![CDATA[ >= ]]> DATE_FORMAT(CURDATE(),'%Y-%m-%d %H:%i:%s')
        AND
            r.modified_time <![CDATA[ <= ]]> DATE_ADD(CURDATE(), INTERVAL 86399 SECOND)
        AND
            r. status = 1
        AND
            r.company_id = cbr.company_id
        AND
            cbr.bankcard_id = b.bankcard_id
        AND
            r.employee_id = p.employee_id
        AND
            cbr.usage = 2
        AND
            p.is_active = 1
        AND
            r.is_active = 1
        AND
            cbr.is_active = 1
        AND
            b.status = 1
    </select>

    <!-- 未同步 -->
    <select id="selectUnSync" resultMap="PartialResultMap">
        SELECT
            <include refid="Partial_Column_List"></include>
        FROM
            hm_supply_medical_acceptance p
        WHERE NOT EXISTS
            (
                SELECT
                    a.acceptance_id
                FROM
                    gtobusinessdb.hm_supply_medical_acceptance a, emp_company_bankcard_relation cbr, emp_bankcard b
                WHERE
                    a.acceptance_id = p.acceptance_id
                AND
                    b.bankcard_id = cbr.bankcard_id
                AND
                    cbr.company_id = a.company_id
                AND
                    b.employee_id = a.employee_id
                AND
                    a.status = 2
                AND
                    cbr.usage = 2
                AND
                    b.status = 1
                AND
                    a.is_active = 1
                AND
                    cbr.is_active = 1
            )
        AND p. status = 2
        AND p.is_active = 1
    </select>

</mapper>
